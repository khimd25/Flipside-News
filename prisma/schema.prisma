// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

model OnboardingBatch {
  id          String              @id @default(cuid())
  generatedAt DateTime            @default(now())
  expiresAt   DateTime
  articles    OnboardingArticle[]
  assignments OnboardingAssignment[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model OnboardingArticle {
  id         String            @id @default(cuid())
  batchId    String
  batch      OnboardingBatch   @relation(fields: [batchId], references: [id], onDelete: Cascade)
  articleId  String
  article    Article           @relation(fields: [articleId], references: [id], onDelete: Cascade)
  title      String
  description String?
  url        String
  sourceName String?
  category   String?
  urlToImage String?
  publishedAt DateTime?
  assignments OnboardingAssignment[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  @@unique([batchId, articleId])
  @@index([url])
}

model OnboardingAssignment {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  batchId   String
  batch     OnboardingBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  articleId String
  article   OnboardingArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  status    OnboardingStatus  @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@unique([userId, articleId])
  @@index([userId, status])
}

enum OnboardingStatus {
  PENDING
  LIKED
  DISLIKED
}

model UserInterest {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic     String
  score     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, topic])
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?   // For email/password authentication
  accounts      Account[]
  sessions      Session[]
  preferences   UserPreference[]
  savedArticles SavedArticle[]
  ratings       UserRating[]
  categories    Category[]
  feedback      SentimentFeedback[]
  onboardingCompleted Boolean       @default(false)
  onboardingCompletedAt DateTime?
  onboardingAssignments OnboardingAssignment[]
  interests           UserInterest[]
  interactions       UserArticleInteraction[] @relation("UserInteractions")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Article {
  id          String        @id @default(cuid())
  sourceId    String?
  sourceName  String
  author      String?
  title       String
  description String?
  url         String        @unique
  urlToImage  String?
  publishedAt DateTime
  content     String?
  sentiment   Float?        // Sentiment score from -1 (negative) to 1 (positive)
  magnitude   Float?        // Magnitude of the sentiment
  savedBy     SavedArticle[]
  ratings     UserRating[]
  category    Category?     @relation(fields: [categoryId], references: [id])
  categoryId  String?
  onboardingEntries OnboardingArticle[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Category {
  id          String        @id @default(cuid())
  name        String
  slug        String
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  articles    Article[]
  savedBy     SavedArticle[]
  defaultFor  UserPreference[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([userId, slug])
}

model SavedArticle {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  articleId  String
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  notes      String?
  isRead     Boolean  @default(false)
  isFavorite Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, articleId])
}

model UserRating {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  rating    Int      // 1-5 scale
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, articleId])
}

model UserPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  defaultCategoryId String?
  defaultCategory   Category? @relation(fields: [defaultCategoryId], references: [id], onDelete: SetNull)
  language          String   @default("en")
  theme             String   @default("system")
  showSentiment     Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model UserArticleInteraction {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserInteractions", fields: [userId], references: [id], onDelete: Cascade)
  articleUrl String
  sourceName String?
  category  String?
  sentiment Float?
  action    String   // 'read' or 'click'
  createdAt DateTime @default(now())

  @@unique([userId, articleUrl, action])
  @@index([userId, createdAt])
}

// User sentiment feedback on an article (by URL)
enum UserSentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

model SentimentFeedback {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  articleUrl    String
  sourceName    String?
  userSentiment UserSentiment
  userScore     Float?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([userId, articleUrl])
}
